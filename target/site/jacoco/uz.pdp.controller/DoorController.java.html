<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DoorController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Project-Modul-10</a> &gt; <a href="index.source.html" class="el_package">uz.pdp.controller</a> &gt; <span class="el_source">DoorController.java</span></div><h1>DoorController.java</h1><pre class="source lang-java linenums">package uz.pdp.controller;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import jakarta.validation.Valid;
import uz.pdp.dto.DoorDto;
import uz.pdp.entity.Door;
import uz.pdp.mutations.DoorConfigInput;
import uz.pdp.service.DoorService;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;

import uz.pdp.payload.EntityResponse;

import java.util.List;
import java.util.Arrays;

@RestController
@RequestMapping(&quot;/api/doors&quot;)
@Tag(name = &quot;Door Management&quot;, description = &quot;APIs for managing doors&quot;)
<span class="fc" id="L31">public class DoorController {</span>

<span class="fc" id="L33">    private static final Logger logger = LoggerFactory.getLogger(DoorController.class);</span>

    @Autowired
    private DoorService doorService;

    @GetMapping(&quot;/{id}&quot;)
    @Operation(summary = &quot;Get door details by ID&quot;, description = &quot;Open to all users&quot;)
    public ResponseEntity&lt;EntityResponse&lt;Door&gt;&gt; getDoor(@PathVariable Long id) {
<span class="nc" id="L41">        logger.info(&quot;Fetching door with id: {}&quot;, id);</span>
<span class="nc" id="L42">        Door door = doorService.getDoor(id);</span>
<span class="nc" id="L43">        return ResponseEntity.ok(EntityResponse.success(&quot;Door retrieved successfully&quot;, door));</span>
    }

    @GetMapping
    @Operation(summary = &quot;Get all doors&quot;, description = &quot;Open to all users&quot;)
    public ResponseEntity&lt;EntityResponse&lt;List&lt;Door&gt;&gt;&gt; getAllDoors() {
<span class="nc" id="L49">        logger.info(&quot;Fetching all doors&quot;);</span>
<span class="nc" id="L50">        List&lt;Door&gt; doors = doorService.getAllDoors();</span>
<span class="nc" id="L51">        logger.debug(&quot;Retrieved {} doors&quot;, doors.size());</span>
<span class="nc" id="L52">        return ResponseEntity.ok(EntityResponse.success(&quot;Doors retrieved successfully&quot;, doors));</span>
    }

    @PostMapping
    @PreAuthorize(&quot;hasRole('SELLER')&quot;)
    @Operation(summary = &quot;Create a new door (SELLER only)&quot;)
    public ResponseEntity&lt;EntityResponse&lt;Door&gt;&gt; createDoor(@Valid @RequestBody DoorDto doorDto) {
<span class="nc" id="L59">        logger.info(&quot;Creating new door: {}&quot;, doorDto);</span>
<span class="nc" id="L60">        Door door = doorService.createDoor(doorDto);</span>
<span class="nc" id="L61">        return ResponseEntity.status(HttpStatus.CREATED)</span>
<span class="nc" id="L62">            .body(EntityResponse.success(&quot;Door created successfully&quot;, door));</span>
    }

    @PutMapping(&quot;/{id}&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN') or (hasRole('SELLER') and @doorSecurityService.isSeller(#id))&quot;)
    @Operation(summary = &quot;Update door details (ADMIN or owner SELLER)&quot;)
    public ResponseEntity&lt;EntityResponse&lt;Door&gt;&gt; updateDoor(
            @PathVariable Long id,
            @Valid @RequestBody DoorDto doorDto) {
<span class="nc" id="L71">        logger.info(&quot;Updating door with id: {}&quot;, id);</span>
<span class="nc" id="L72">        Door updatedDoor = doorService.updateDoor(id, doorDto);</span>
<span class="nc" id="L73">        logger.info(&quot;Successfully updated door with id: {}&quot;, id);</span>
<span class="nc" id="L74">        return ResponseEntity.ok(EntityResponse.success(&quot;Door updated successfully&quot;, updatedDoor));</span>
    }

    @DeleteMapping(&quot;/{id}&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN') or (hasRole('SELLER') and @doorSecurityService.isSeller(#id))&quot;)
    @Operation(summary = &quot;Delete a door (ADMIN or owner SELLER)&quot;)
    public ResponseEntity&lt;EntityResponse&lt;Void&gt;&gt; deleteDoor(@PathVariable Long id) {
<span class="nc" id="L81">        logger.info(&quot;Deleting door with id: {}&quot;, id);</span>
<span class="nc" id="L82">        doorService.deleteDoor(id);</span>
<span class="nc" id="L83">        logger.info(&quot;Successfully deleted door with id: {}&quot;, id);</span>
<span class="nc" id="L84">        return ResponseEntity.ok(EntityResponse.success(&quot;Door deleted successfully&quot;));</span>
    }

    @PostMapping(&quot;/{id}/configure&quot;)
    @PreAuthorize(&quot;hasRole('ADMIN') or (hasRole('SELLER') and @doorSecurityService.isSeller(#id))&quot;)
    @Operation(summary = &quot;Configure door size and color (ADMIN or owner SELLER)&quot;)
    public ResponseEntity&lt;EntityResponse&lt;Door&gt;&gt; configureDoor(
            @PathVariable Long id,
            @Valid @RequestBody DoorConfigInput configInput
    ) {
<span class="nc" id="L94">        logger.info(&quot;Configuring door with ID: {}, configuration: {}&quot;, id, configInput);</span>
        try {
<span class="nc" id="L96">            Door configuredDoor = doorService.configureDoor(</span>
                    id,
<span class="nc" id="L98">                    configInput.getSize(),</span>
<span class="nc" id="L99">                    configInput.getColor(),</span>
<span class="nc" id="L100">                    configInput.getWidth(),</span>
<span class="nc" id="L101">                    configInput.getHeight()</span>
            );
<span class="nc" id="L103">            return ResponseEntity.ok(EntityResponse.success(&quot;Door configured successfully&quot;, configuredDoor));</span>
<span class="nc" id="L104">        } catch (Exception e) {</span>
<span class="nc" id="L105">            logger.error(&quot;Error configuring door: {}&quot;, e.getMessage());</span>
<span class="nc" id="L106">            return ResponseEntity.badRequest()</span>
<span class="nc" id="L107">                    .body(EntityResponse.error(&quot;Failed to configure door: &quot; + e.getMessage()));</span>
        }
    }

    @PostMapping(value = &quot;/{id}/images&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @PreAuthorize(&quot;hasRole('ADMIN') or (hasRole('SELLER') and @doorSecurityService.isSeller(#id))&quot;)
    @Operation(summary = &quot;Upload door images (ADMIN or owner SELLER)&quot;)
    public ResponseEntity&lt;EntityResponse&lt;Door&gt;&gt; uploadImages(
            @PathVariable Long id,
            @RequestPart(&quot;images&quot;) MultipartFile[] images) {
<span class="nc" id="L117">        logger.info(&quot;Uploading {} images for door ID: {}&quot;, images.length, id);</span>
<span class="nc" id="L118">        Door door = doorService.addImages(id, Arrays.asList(images));</span>
<span class="nc" id="L119">        return ResponseEntity.ok(EntityResponse.success(&quot;Images uploaded successfully&quot;, door));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>