<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EmailService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Project-Modul-10</a> &gt; <a href="index.source.html" class="el_package">uz.pdp.service</a> &gt; <span class="el_source">EmailService.java</span></div><h1>EmailService.java</h1><pre class="source lang-java linenums">package uz.pdp.service;

import java.util.Random;
import java.util.UUID;
import java.util.logging.Logger;
import java.util.regex.Pattern;

import org.springframework.beans.factory.annotation.Value;
import org.springframework.mail.MailSendException;
import org.springframework.mail.SimpleMailMessage;
import org.springframework.mail.javamail.JavaMailSender;
import org.springframework.mail.javamail.MimeMessageHelper;
import org.springframework.stereotype.Service;
import lombok.extern.slf4j.Slf4j;
import uz.pdp.payload.EntityResponse;

import jakarta.mail.MessagingException;
import jakarta.mail.internet.MimeMessage;

@Service
<span class="fc" id="L21">@Slf4j</span>
public class EmailService {
    


    private final JavaMailSender mailSender;
    private final String fromEmail;

    @Value(&quot;${email.validation.enabled:true}&quot;)
    private boolean emailValidationEnabled;

<span class="fc" id="L32">    public EmailService(JavaMailSender mailSender, @Value(&quot;${spring.mail.username}&quot;) String fromEmail) {</span>
<span class="fc" id="L33">        this.mailSender = mailSender;</span>
<span class="fc" id="L34">        this.fromEmail = fromEmail;</span>
<span class="fc" id="L35">    }</span>

    public boolean isValidEmail(String email) {
<span class="nc bnc" id="L38" title="All 4 branches missed.">        if (email == null || email.isBlank()) {</span>
<span class="nc" id="L39">            return false;</span>
        }
<span class="nc" id="L41">        String emailRegex = &quot;^[A-Za-z0-9+_.-]+@(.+)$&quot;;</span>
<span class="nc" id="L42">        Pattern pattern = Pattern.compile(emailRegex);</span>
<span class="nc" id="L43">        return pattern.matcher(email).matches();</span>
    }

    public EntityResponse&lt;String&gt; sendVerificationEmail(String toEmail) {
        // First validate email format
<span class="nc bnc" id="L48" title="All 2 branches missed.">        if (!isValidEmail(toEmail)) {</span>
<span class="nc" id="L49">            log.warn(&quot;Invalid email format: {}&quot;, toEmail);</span>
<span class="nc" id="L50">            return EntityResponse.error(&quot;Invalid email format&quot;);</span>
        }

        try {
<span class="nc" id="L54">            SimpleMailMessage message = new SimpleMailMessage();</span>
<span class="nc" id="L55">            message.setFrom(fromEmail);</span>
<span class="nc" id="L56">            message.setTo(toEmail);</span>
<span class="nc" id="L57">            message.setSubject(&quot;Email Verification&quot;);</span>
<span class="nc" id="L58">            message.setText(&quot;Your verification code is: &quot; + generateVerificationCode());</span>

<span class="nc bnc" id="L60" title="All 2 branches missed.">            if (emailValidationEnabled) {</span>
<span class="nc" id="L61">                mailSender.send(message);</span>
<span class="nc" id="L62">                log.info(&quot;Verification email sent successfully to: {}&quot;, toEmail);</span>
<span class="nc" id="L63">                return EntityResponse.success(&quot;Email sent successfully&quot;);</span>
            } else {
<span class="nc" id="L65">                log.info(&quot;Email validation disabled. Would have sent to: {}&quot;, toEmail);</span>
<span class="nc" id="L66">                return EntityResponse.success(&quot;Email validation disabled&quot;);</span>
            }
<span class="nc" id="L68">        } catch (MailSendException e) {</span>
<span class="nc" id="L69">            log.error(&quot;Failed to send verification email to: {}&quot;, toEmail);</span>
<span class="nc" id="L70">            return EntityResponse.error(&quot;Failed to send email&quot;);</span>
        }
    }

    public EntityResponse&lt;String&gt; sendVerificationEmail(String toEmail, String verificationCode) {
<span class="nc bnc" id="L75" title="All 2 branches missed.">        if (!isValidEmail(toEmail)) {</span>
<span class="nc" id="L76">            log.warn(&quot;Invalid email format: {}&quot;, toEmail);</span>
<span class="nc" id="L77">            return EntityResponse.error(&quot;Invalid email format&quot;);</span>
        }

        try {
<span class="nc" id="L81">            MimeMessage mimeMessage = mailSender.createMimeMessage();</span>
<span class="nc" id="L82">            MimeMessageHelper helper = new MimeMessageHelper(mimeMessage, true, &quot;UTF-8&quot;);</span>
            
<span class="nc" id="L84">            helper.setFrom(fromEmail);</span>
<span class="nc" id="L85">            helper.setTo(toEmail);</span>
<span class="nc" id="L86">            helper.setSubject(&quot;üöÄ Etadoor Seller Verification&quot;);</span>
            
<span class="nc" id="L88">            String htmlContent = String.format(&quot;&quot;&quot;</span>
                &lt;div style=&quot;font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;&quot;&gt;
                    &lt;div style=&quot;background-color: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;&quot;&gt;
                        &lt;h1 style=&quot;color: #333; margin-bottom: 20px;&quot;&gt;ETADOOR VERIFICATION&lt;/h1&gt;
                        
                        &lt;p style=&quot;font-size: 18px; color: #666;&quot;&gt;Hello Future Seller! üéâ&lt;/p&gt;
                        
                        &lt;div style=&quot;margin: 30px 0;&quot;&gt;
                            &lt;p style=&quot;font-size: 16px; color: #666;&quot;&gt;Your verification code is:&lt;/p&gt;
                            
                            &lt;div style=&quot;background-color: #fff; border: 2px solid #ddd; border-radius: 10px; 
                                      padding: 20px; margin: 20px 0; font-size: 32px; letter-spacing: 5px;&quot;&gt;
                                %s
                            &lt;/div&gt;
                        &lt;/div&gt;
                        
                        &lt;p style=&quot;color: #dc3545; font-size: 14px;&quot;&gt;‚ö†Ô∏è This code will expire in 15 minutes&lt;/p&gt;
                        
                        &lt;div style=&quot;background-color: #e9ecef; padding: 15px; border-radius: 5px; margin: 20px 0;&quot;&gt;
                            &lt;h3 style=&quot;color: #333; margin-bottom: 10px;&quot;&gt;üîí Security Notice&lt;/h3&gt;
                            &lt;ul style=&quot;text-align: left; color: #666;&quot;&gt;
                                &lt;li&gt;Keep this code private&lt;/li&gt;
                                &lt;li&gt;Never share it with anyone&lt;/li&gt;
                                &lt;li&gt;Our team will never ask for it&lt;/li&gt;
                            &lt;/ul&gt;
                        &lt;/div&gt;
                        
                        &lt;div style=&quot;margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd;&quot;&gt;
                            &lt;p style=&quot;color: #666;&quot;&gt;Thank you for joining Etadoor!&lt;/p&gt;
                            &lt;p style=&quot;color: #666;&quot;&gt;Best regards,&lt;br&gt;The Etadoor Team üè™&lt;/p&gt;
                        &lt;/div&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
                &quot;&quot;&quot;, verificationCode);

<span class="nc" id="L123">            helper.setText(htmlContent, true);</span>

<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (emailValidationEnabled) {</span>
<span class="nc" id="L126">                mailSender.send(mimeMessage);</span>
<span class="nc" id="L127">                log.info(&quot;Verification email sent successfully to: {}&quot;, toEmail);</span>
<span class="nc" id="L128">                return EntityResponse.success(&quot;Email sent successfully&quot;);</span>
            } else {
<span class="nc" id="L130">                log.info(&quot;Email validation disabled. Code: {} for: {}&quot;, verificationCode, toEmail);</span>
<span class="nc" id="L131">                return EntityResponse.success(&quot;Email validation disabled&quot;);</span>
            }
<span class="nc" id="L133">        } catch (MessagingException | MailSendException e) {</span>
<span class="nc" id="L134">            log.error(&quot;Failed to send verification email to: {}&quot;, toEmail, e);</span>
<span class="nc" id="L135">            return EntityResponse.error(&quot;Failed to send email&quot;);</span>
        }
    }

    private String generateVerificationCode() {
<span class="nc" id="L140">        return String.format(&quot;%06d&quot;, new Random().nextInt(999999));</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.11.202310140853</span></div></body></html>